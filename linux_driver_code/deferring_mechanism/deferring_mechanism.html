<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-04-22 一 21:26 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Work Deferring Mechanism</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Yanqing Li" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../../style.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Work Deferring Mechanism</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org65b5888">1. Tasklets</a>
<ul>
<li><a href="#orgf52cd8d">1.1. Declare</a></li>
<li><a href="#org8b652cd">1.2. Ealabing and disabling a tasklet</a></li>
<li><a href="#orge9349cd">1.3. Tasklet scheduling</a></li>
<li><a href="#org0ee2379">1.4. Example Code</a></li>
</ul>
</li>
<li><a href="#org2ba8a01">2. Work queues</a>
<ul>
<li><a href="#org236c289">2.1. Kernel-global workqueue - the shared queue</a>
<ul>
<li><a href="#orgf405969">2.1.1. Initialize the workqueue</a></li>
<li><a href="#org6ed2e89">2.1.2. Schedule the workqueue</a></li>
</ul>
</li>
<li><a href="#orgd766761">2.2. Dedicated work queue</a>
<ul>
<li><a href="#org1689cc2">2.2.1. Initialize our work queue and embed our work into:</a></li>
<li><a href="#orgaef0384">2.2.2. Scheduling work:</a></li>
<li><a href="#org532b140">2.2.3. Wait on all pending work on the given work queue:</a></li>
<li><a href="#orgebd5025">2.2.4. Cleanup:</a></li>
<li><a href="#org71fc136">2.2.5. Example Code</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
There are three deferring mechanism in the kernel:
</p>
<ul class="org-ul">
<li><b>SoftIRQs</b>: Executed in an atomic context</li>
<li><b>Tasklets</b>: Executed in an atomic context</li>
<li><b>Workueues</b>: Executed in a process context</li>
</ul>

<div id="outline-container-org65b5888" class="outline-2">
<h2 id="org65b5888"><span class="section-number-2">1</span> Tasklets</h2>
<div class="outline-text-2" id="text-1">
<p>
Tasklets are an instantiation of softirqs, and will be sufficient in almost every case that you feel the ned to use softirqs.
Tasklets are a bottom-half mechanism built on top of softirqs.
Tasklet can run on one and only one CPU simultaneously, which is the CPU it was scheduled on, but different tasklets may be run simultaneously
on different CPUs.
</p>

<p>
Tasklet are represented in the kernel as instances of struct tasklet_struct:
</p>
<pre class="example">
struct tasklet_struct
{
	struct tasklet_struct *next;
	unsigned long state;
	atomic_t count;
	void (*func)(unsigned long);
	unsigned long data;
};
</pre>
</div>

<div id="outline-container-orgf52cd8d" class="outline-3">
<h3 id="orgf52cd8d"><span class="section-number-3">1.1</span> Declare</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>Dynamically:</li>
</ul>
<pre class="example">
void tasklet_init(struct tasklet_struct *t,
			 void (*func)(unsigned long), unsigned long data);
</pre>

<ul class="org-ul">
<li>Statically:</li>
</ul>
<pre class="example">
DECLARE_TASKLET(name, func, data);
DECLARE_TASKLET_DISABLED(name, func, data);
</pre>

<p>
There is one difference between above two functins, the former cteates a tasklet already enabled and ready to e scheduled without any other funciton call,
done by setting the count field to 0, whereas the latter creates a tasklet disabled(done by setting count to 1), on which one has to call tasklet_enable()
before the tasklet can be schedulable.
</p>
</div>
</div>

<div id="outline-container-org8b652cd" class="outline-3">
<h3 id="org8b652cd"><span class="section-number-3">1.2</span> Ealabing and disabling a tasklet</h3>
<div class="outline-text-3" id="text-1-2">
<p>
tasklet_enable() function is used to enable a tasklet:
</p>
<pre class="example">
void tasklet_enable(struct tasklet_struct *t);
</pre>

<p>
You can call tasklet_disable() function to disable a tasklet, and it will disable the tasklet and return only when the tasklet has terminated its execution(if it was running),
or call tasklet_disable_nosync returns immediately, even if the termination has not occured.
</p>
<pre class="example">
void tasklet_disable(struct tasklet_struct *t);
void tasklet_disable_nosync(struct tasklet_struct *t);
</pre>
</div>
</div>

<div id="outline-container-orge9349cd" class="outline-3">
<h3 id="orge9349cd"><span class="section-number-3">1.3</span> Tasklet scheduling</h3>
<div class="outline-text-3" id="text-1-3">
<p>
There are two scheduling functions for tasklet, depending on whther your tasklet has normal or higher priority:
</p>
<pre class="example">
void tasklet_schedule(struct tasklet_struct *t);
void tasklet_hi_schedule(struct tasklet_struct *t);
</pre>

<p>
The kernel maintains normal priority and high priority tasklets in two different lists.
tasklet_schedule adds the tasklet into the normal priority list, scheduling the associated softirq with a TASKLET_SOFTIRQ flag. With tasklet_hi__schedule,
the tasklet is added into the high priority list, scheduling the associated softirq with a HI_SOFTIRQ flag. High priority tasklets are meant to be used for
soft interrupt handlers with low latency requirements. There are some properties associated with tasklets you should know.
</p>

<ul class="org-ul">
<li>Calling tasklet_schedule on a tasklet already scheduled, but whose executions has not started, will do nothing, resulting in the tasklet being executed only once.</li>
<li>tasklet_schedule can be called in a tasklet, meaning that a tasklet can reschedule itself.</li>
<li>Hight prority tasks will increase the system latency. Only use them for really quick stuff.</li>
</ul>

<p>
You can stop a tasklet using the tasklet_kill function that wil prevent the tasklet from running again or wait for its completion before killing it if the tasklet is currently scheduled to run.
</p>
<pre class="example">
void tasklet_kill(struct tasklet_struct *t);
</pre>
</div>
</div>

<div id="outline-container-org0ee2379" class="outline-3">
<h3 id="org0ee2379"><span class="section-number-3">1.4</span> Example Code</h3>
<div class="outline-text-3" id="text-1-4">
<p>
<a href="./src/tasklet.c">tasklet.c</a>
</p>
</div>
</div>
</div>

<div id="outline-container-org2ba8a01" class="outline-2">
<h2 id="org2ba8a01"><span class="section-number-2">2</span> Work queues</h2>
<div class="outline-text-2" id="text-2">
<p>
There are two types of work queue, one is shared work queue, another is dedicated work queue, the shared work queue are handled by a set of kernel threads,
each running on a CPU. Once you have work to schedule, you queue that work into the global work queue, which will be executed at the appropriate moment.
The dedicated work queue run the work queue in a dedicated kernel thread. It means whenever your work queue handler needs to be executed, your kernel thread
is woken up to handle it, instead of one of the default predefined threads.
</p>
</div>

<div id="outline-container-org236c289" class="outline-3">
<h3 id="org236c289"><span class="section-number-3">2.1</span> Kernel-global workqueue - the shared queue</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-orgf405969" class="outline-4">
<h4 id="orgf405969"><span class="section-number-4">2.1.1</span> Initialize the workqueue</h4>
<div class="outline-text-4" id="text-2-1-1">
<pre class="example">
INIT_WORK(_work, _func);
</pre>
</div>
</div>

<div id="outline-container-org6ed2e89" class="outline-4">
<h4 id="org6ed2e89"><span class="section-number-4">2.1.2</span> Schedule the workqueue</h4>
<div class="outline-text-4" id="text-2-1-2">
<pre class="example">
bool schedule_work(struct work_struct *work);
bool schedule_delayed_work(struct delayed_work *dwork,
					 unsigned long delay);
bool schedule_work_on(int cpu, struct work_struct *work);
bool schedule_delayed_work_on(int cpu, struct delayed_work *dwork,
					    unsigned long delay);
</pre>

<p>
A work already submitted to the shared queue can be cancelled with the cancel_delayed_work function, You can flush the shared workqueue with:
</p>
<pre class="example">
void flush_scheduled_work(void);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd766761" class="outline-3">
<h3 id="orgd766761"><span class="section-number-3">2.2</span> Dedicated work queue</h3>
<div class="outline-text-3" id="text-2-2">
<p>
There are four steps to scheduling your work in your own kernel thread:
</p>
<ul class="org-ul">
<li>Declare/initialize a struct workqueue_struct.</li>
<li>Create your work function.</li>
<li>Create a struct work_struct so that your work function will be embedded into it.</li>
<li>Embed your work function in the work_struct.</li>

<li>Declare work and work queue:</li>
</ul>
<pre class="example">
struct workqueue_struct *myqueue;
struct work_struct mywork;
</pre>

<ul class="org-ul">
<li>Define the worker function (the handler):</li>
</ul>
<pre class="example">
void dowork(void *data) { /* Code goes heae */ };
</pre>
</div>

<div id="outline-container-org1689cc2" class="outline-4">
<h4 id="org1689cc2"><span class="section-number-4">2.2.1</span> Initialize our work queue and embed our work into:</h4>
<div class="outline-text-4" id="text-2-2-1">
<pre class="example">
myqueue = create_singlethread_workqueue("mywork");
INIT_WORK( &amp;mywork, dowork, &lt;data-pointer&gt; );
</pre>
</div>
</div>

<div id="outline-container-orgaef0384" class="outline-4">
<h4 id="orgaef0384"><span class="section-number-4">2.2.2</span> Scheduling work:</h4>
<div class="outline-text-4" id="text-2-2-2">
<pre class="example">
queue_work(myqueue, &amp;mywork);
</pre>
<p>
Queue after the given  delay to the given worker thread:
</p>
<pre class="example">
queue_delayed_work(myqueue, &amp;mywork, &lt;delay&gt;);
</pre>
</div>
</div>

<div id="outline-container-org532b140" class="outline-4">
<h4 id="org532b140"><span class="section-number-4">2.2.3</span> Wait on all pending work on the given work queue:</h4>
<div class="outline-text-4" id="text-2-2-3">
<pre class="example">
void flush_workqueue(struct workqueue_struct *wq);
</pre>
<p>
flush_workqueue sleeps until all queued work has finished their execution.
</p>
</div>
</div>

<div id="outline-container-orgebd5025" class="outline-4">
<h4 id="orgebd5025"><span class="section-number-4">2.2.4</span> Cleanup:</h4>
<div class="outline-text-4" id="text-2-2-4">
<p>
Use cancle_work_sync() or cancel_delayed_work_sync for synchronous cancellation, which will cancel the work if it is not already running, or block until the work has completed.
The work will be cancelled even if it requeues itself.
</p>
<pre class="example">
bool cancel_work_sync(struct work_struct *work);
bool cancel_delayed_work_sync(struct delayed_work *dwork);
</pre>

<p>
cancel_work and cancel_delayed_work which are aynchronous forms of cancellation.
</p>
</div>
</div>

<div id="outline-container-org71fc136" class="outline-4">
<h4 id="org71fc136"><span class="section-number-4">2.2.5</span> Example Code</h4>
<div class="outline-text-4" id="text-2-2-5">
<p>
<a href="./src/work_queue.c">workqueue_example.c</a>
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Yanqing Li</p>
<p class="date">Created: 2019-04-22 一 21:26</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
